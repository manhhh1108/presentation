# CD (Continuous Delivery/Deployment)
# Chỉ chạy sau khi PR được MERGE vào nhánh main.
# Mục tiêu: dev thấy "merge là auto deploy production".

name: CD - Deploy to Render (Production)

on:
  # Dùng pull_request closed để bắt sự kiện merge.
  pull_request:
    types: [closed]

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Chỉ deploy khi PR thật sự merged vào main
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main'

    steps:
      - name: Trigger Render Deploy Hook
        env:
          # Tạo secret này trong GitHub:
          # Settings → Secrets and variables → Actions → New repository secret
          # Name: RENDER_DEPLOY_HOOK_URL
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        shell: bash
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "Missing secret: RENDER_DEPLOY_HOOK_URL" >&2
            exit 1
          fi

          echo "Triggering Render deploy (production) ..."
          curl -fsSL -X POST "$RENDER_DEPLOY_HOOK_URL"
          echo "Deploy triggered after merge to main."
