name: CD - Deploy to EC2

on:
  workflow_run:
    workflows: ["CI - Build & Test"]
    types:
      - completed
    branches:
      - main

concurrency:
  group: deploy-ec2
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHub-Deploy-Role
          aws-region: ap-northeast-1

      - name: Trigger EC2 Deploy via SSM
        id: trigger
        run: |
          VERSION="${{ github.event.workflow_run.head_sha }}"

          DOC_NAME="${{secrets.SSM_DOCUMENT_NAME}}"
          if [ -z "$DOC_NAME" ]; then
            echo "Missing SSM document name. Set secret SSM_DOCUMENT_NAME." >&2
            exit 1
          fi

          echo "Using SSM document: $DOC_NAME"
          echo "Target: tag Environment=Production"
          echo "Version: $VERSION"

          COMMAND_ID=$(aws ssm send-command \
            --document-name "$DOC_NAME" \
            --targets "Key=tag:Environment,Values=Production" \
            --parameters "version=$VERSION" \
            --cloud-watch-output-config '{"CloudWatchOutputEnabled":true, "CloudWatchLogGroupName":"/aws/ssm/presentation-deploy"}' \
            --comment "Deploying Artifact $VERSION" \
            --query 'Command.CommandId' \
            --output text)
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to complete..."
          sleep 10
          
          # Poll for command status
          for i in {1..60}; do
            INVOCATION_COUNT=$(aws ssm list-command-invocations \
              --command-id ${{ steps.trigger.outputs.command_id }} \
              --query 'length(CommandInvocations)' \
              --output text 2>/dev/null || echo "0")

            if [ "$INVOCATION_COUNT" = "0" ] || [ "$INVOCATION_COUNT" = "None" ]; then
              echo "No command invocations yet (attempt $i/60)." 
              echo "Common causes: no EC2 matches tag Environment=Production, or instance is not an SSM managed instance." 
              aws ssm list-commands \
                --command-id ${{ steps.trigger.outputs.command_id }} \
                --query 'Commands[0].{Status:Status,StatusDetails:StatusDetails,RequestedDateTime:RequestedDateTime,DocumentName:DocumentName,Targets:Targets}' \
                --output yaml || true
              sleep 10
              continue
            fi

            STATUS=$(aws ssm list-commands \
              --command-id ${{ steps.trigger.outputs.command_id }} \
              --query 'Commands[0].Status' \
              --output text 2>/dev/null || echo "Pending")

            echo "Status: $STATUS (attempt $i/60, invocations=$INVOCATION_COUNT)"
            
            if [ "$STATUS" = "Success" ]; then
              echo "Deployment completed successfully!"
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "Deployment failed with status: $STATUS"
              
              echo "Invocation summary:"
              aws ssm list-command-invocations \
                --command-id ${{ steps.trigger.outputs.command_id }} \
                --details \
                --query 'CommandInvocations[].{InstanceId:InstanceId,Status:Status,StatusDetails:StatusDetails}' \
                --output table || true

              echo "Plugin output (first plugin per instance):"
              aws ssm list-command-invocations \
                --command-id ${{ steps.trigger.outputs.command_id }} \
                --details \
                --query 'CommandInvocations[].{InstanceId:InstanceId,Plugin:CommandPlugins[0].Name,ResponseCode:CommandPlugins[0].ResponseCode,Output:CommandPlugins[0].Output}' \
                --output yaml || true
              
              exit 1
            fi
            
            sleep 10
          done
          
          echo "Deployment timed out"
          exit 1
