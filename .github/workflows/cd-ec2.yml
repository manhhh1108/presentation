name: CD - Deploy to EC2

on:
  workflow_run:
    workflows: ["CI - Build & Test"]
    types:
      - completed
    branches:
      - main

concurrency:
  group: deploy-ec2
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHub-Deploy-Role
          aws-region: ap-northeast-1

      - name: Trigger EC2 Deploy via SSM
        id: trigger
        run: |
          echo "Triggering deployment on EC2..."
          COMMAND_ID=$(aws ssm send-command \
            --document-name "${{ secrets.SSM_DOCUMENT_NAME }}" \
            --targets "Key=tag:Environment,Values=Production" \
            --parameters "commitSha=${{ github.event.workflow_run.head_sha }},s3Bucket=${{ secrets.S3_BUCKET }},appPath=/var/www/presentation" \
            --cloud-watch-output-config '{"CloudWatchOutputEnabled":true, "CloudWatchLogGroupName":"/aws/ssm/presentation-deploy"}' \
            --comment "Deploying commit ${{ github.event.workflow_run.head_sha }}" \
            --query 'Command.CommandId' \
            --output text)
          
          echo "SSM Command ID: $COMMAND_ID"
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to complete..."
          sleep 10
          
          # Poll for command status
          for i in {1..60}; do
            STATUS=$(aws ssm list-command-invocations \
              --command-id ${{ steps.trigger.outputs.command_id }} \
              --details \
              --query 'CommandInvocations[0].Status' \
              --output text 2>/dev/null || echo "Pending")
            
            echo "Status: $STATUS (attempt $i/60)"
            
            if [ "$STATUS" = "Success" ]; then
              echo "Deployment completed successfully!"
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "Deployment failed with status: $STATUS"
              
              # Get error output
              aws ssm list-command-invocations \
                --command-id ${{ steps.trigger.outputs.command_id }} \
                --details \
                --query 'CommandInvocations[0].CommandPlugins[0].Output' \
                --output text || true
              
              exit 1
            fi
            
            sleep 10
          done
          
          echo "Deployment timed out"
          exit 1
