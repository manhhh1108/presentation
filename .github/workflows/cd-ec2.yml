name: CD - Deploy to EC2

on:
  workflow_run:
    workflows: ["CI - Build & Test"]
    types:
      - completed
    branches:
      - main

concurrency:
  group: deploy-ec2
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_PORT: ${{ secrets.EC2_PORT || '22' }}
      EC2_APP_PATH: ${{ secrets.EC2_APP_PATH }}
    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-package-${{ github.event.workflow_run.head_sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Setup SSH
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "$EC2_PORT" -H "$EC2_HOST" >> ~/.ssh/known_hosts

      - name: Upload package to server
        shell: bash
        run: |
          scp -P "$EC2_PORT" deploy.tgz "$EC2_USER@$EC2_HOST:/tmp/deploy-${{ github.event.workflow_run.head_sha }}.tgz"

      - name: Deploy on server
        shell: bash
        run: |
          ssh -p "$EC2_PORT" "$EC2_USER@$EC2_HOST" << 'ENDSSH'
          set -euo pipefail

          APP_PATH="${{ secrets.EC2_APP_PATH }}"
          DEPLOY_PKG="/tmp/deploy-${{ github.event.workflow_run.head_sha }}.tgz"

          echo "Deploying to $APP_PATH..."

          # Create app directory if not exists
          mkdir -p "$APP_PATH"

          # Extract package
          tar -xzf "$DEPLOY_PKG" -C "$APP_PATH"
          rm -f "$DEPLOY_PKG"

          cd "$APP_PATH"

          # Install production dependencies
          echo "Installing dependencies..."
          composer install --no-dev --prefer-dist --no-interaction --no-progress --optimize-autoloader

          # Run migrations
          echo "Running migrations..."
          php artisan migrate --force

          # Clear and cache
          echo "Optimizing application..."
          php artisan optimize:clear || true
          php artisan config:cache
          php artisan route:cache || true
          php artisan view:cache || true
          php artisan event:cache || true
          
          # Create storage link
          php artisan storage:link || true

          # Set permissions (adjust as needed)
          chmod -R 775 storage bootstrap/cache
          
          echo "Deployment completed successfully!"
          ENDSSH

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment to EC2 successful!"
          else
            echo "❌ Deployment to EC2 failed!"
          fi
